<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Reservasi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">
        <form id="formReservasi">
            <h3>Buat Reservasi</h3>

            <div class="mb-2">
                <label class="form-label">Pilih Tiket</label>
                <select id="pilihTiket" class="form-select" required>
                    <option value="">-- Pilih Tiket--</option>
                </select>
                <div id="infoTiket" class="form-text">Pilih tiket yang tersedia.</div>
            </div>

            <div class="mb-2">
                <label class="form-label">Nama Tiket</label>
                <input type="text" id="namaTiketDisplay" class="form-control" readonly>
            </div>

            <div class="mb-2">
                <label class="form-label">Nama Reservasi</label>
                <input type="text" id="namaReservasi" class="form-control" required>
            </div>

            <div class="mb-2">
                <label class="form-label">Jumlah</label>
                <input type="number" id="jumlahTiket" class="form-control" required min="1" value="1">
            </div>

            <div class="mb-2">
                <label class="form-label">Harga Tiket</label>
                <input type="text" id="hargaTiketDisplay" class="form-control" readonly>
            </div>

            <div class="mb-2">
                <label class="form-label">Total Bayar</label>
                <input type="text" id="totalBayarDisplay" class="form-control" readonly>
            </div>

            <input type="hidden" id="totalBayar">
            <input type="hidden" id="tanggalReservasi">
            <input type="hidden" id="statusReservasi" value="1">

            <button type="submit" class="btn btn-primary mt-3">Simpan</button>
            <button type="button" class="btn btn-warning mt-3"
                onclick="window.location.href='ReadReservasi.html'">Kembali</button>
            <div id="hasil" class="mt-3"></div>
        </form>
    </div>

    <script>

        const pilihTiket = document.getElementById('pilihTiket');
        const namaTiketDisplay = document.getElementById('namaTiketDisplay');
        const hargaTiketDisplay = document.getElementById('hargaTiketDisplay');
        const jumlahTiket = document.getElementById('jumlahTiket');
        const totalBayarDisplay = document.getElementById('totalBayarDisplay');
        const totalBayar = document.getElementById('totalBayar');
        const tanggalReservasi = document.getElementById('tanggalReservasi');
        const namaReservasi = document.getElementById('namaReservasi');
        const formReservasi = document.getElementById('formReservasi');
        const hasil = document.getElementById('hasil');

        let hargaTiket = 0;

        // Fungsi utilitas
        function formatRupiah(angka) {
            if (!angka || angka === "") return "";
            return Number(angka).toLocaleString('id-ID');
        }

        function tanggalHariIni() {
            const sekarang = new Date();
            const tahun = sekarang.getFullYear();
            const bulan = String(sekarang.getMonth() + 1).padStart(2, '0');
            const tanggal = String(sekarang.getDate()).padStart(2, '0');
            return `${tahun}-${bulan}-${tanggal}`;
        }

        async function ambilTiket() {
            try {
                const response = await fetch('https://asm.roniprsty.com/tiket/read.php');
                const data = await response.json();
                if (!data || data.status !== 'success' || !Array.isArray(data.data)) return [];
                return data.data.filter(tiket => String(tiket.tik_status) === '1' || String(tiket.tiket_status) === '1');
            } catch (error) {
                console.error('Error mengambil tiket:', error);
                return [];
            }
        }

        function hitungTotal(jumlah, harga) {
            jumlah = Number(jumlah) || 0;
            harga = Number(harga) || 0;
            const gratis = Math.floor(jumlah / 5);
            const jumlahBayar = Math.max(0, jumlah - gratis);
            return jumlahBayar * harga;
        }

        async function perbaruiInfoTiket() {
            const idTiket = pilihTiket.value;
            namaTiketDisplay.value = '';
            hargaTiketDisplay.value = '';
            hargaTiket = 0;

            if (!idTiket) return;

            const opsi = pilihTiket.options[pilihTiket.selectedIndex];
            const harga = opsi ? opsi.dataset.price : 0;
            const nama = opsi ? opsi.dataset.name : '';

            hargaTiket = Number(harga || 0);
            namaTiketDisplay.value = nama || '';
            hargaTiketDisplay.value = hargaTiket ? `Rp ${formatRupiah(hargaTiket)}` : '';
            document.getElementById('infoTiket').textContent = 'Tiket dipilih';
            hitungTotalBayar();
        }

        // Fungsi untuk menghitung total bayar
        function hitungTotalBayar() {
            const jumlah = Number(jumlahTiket.value) || 0;
            const total = hitungTotal(jumlah, hargaTiket);
            totalBayar.value = total;
            totalBayarDisplay.value = total ? `Rp ${formatRupiah(total)}` : '';
        }

        tanggalReservasi.value = tanggalHariIni();

        (async function isiPilihanTiket() {
            const daftarTiket = await ambilTiket();
            daftarTiket.forEach(tiket => {
                const opsi = document.createElement('option');
                opsi.value = tiket.tik_id || tiket.tiket_id || '';
                opsi.textContent = `${opsi.value} - ${tiket.tik_nama || tiket.tiket_nama || ''} (Rp ${formatRupiah(tiket.tik_harga || tiket.tiket_harga || 0)})`;
                opsi.dataset.price = tiket.tik_harga || tiket.tiket_harga || 0;
                opsi.dataset.name = tiket.tik_nama || tiket.tiket_nama || '';
                pilihTiket.appendChild(opsi);
            });

            pilihTiket.addEventListener('change', perbaruiInfoTiket);
            if (pilihTiket.options.length > 1) {
                pilihTiket.selectedIndex = 1;
                perbaruiInfoTiket();
            }
        })();

        jumlahTiket.addEventListener('input', hitungTotalBayar);

        formReservasi.addEventListener('submit', async function (e) {
            e.preventDefault();

            const idTiket = pilihTiket.value.trim();
            const nama = namaReservasi.value.trim();
            const jumlah = parseInt(jumlahTiket.value, 10) || 0;
            const total = parseInt(totalBayar.value, 10) || 0;
            const tanggal = tanggalReservasi.value || tanggalHariIni();

            // Validasi input
            if (!idTiket) {
                alert('Pilih ID Tiket');
                return;
            }
            if (!nama) {
                alert('Masukkan nama reservasi');
                return;
            }
            if (jumlah <= 0) {
                alert('Jumlah harus minimal 1');
                return;
            }
            if (hargaTiket <= 0) {
                alert('Harga tiket tidak tersedia. Pastikan ID tiket benar.');
                return;
            }

            // Data untuk dikirim ke API
            const data = {
                tik_id: idTiket,
                rsv_nama: nama,
                rsv_qty: jumlah,
                rsv_total: total,
                rsv_tanggal: tanggal
            };

            try {
                const response = await fetch('https://asm.roniprsty.com/reservasi/create.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const hasilResponse = await response.json();
                const kelasAlert = hasilResponse.status === 'success' ? 'success' : 'danger';
                hasil.innerHTML = `<div class="alert alert-${kelasAlert}">${hasilResponse.message}</div>`;

                if (hasilResponse.status === 'success') {
                    formReservasi.reset();
                    namaTiketDisplay.value = '';
                    hargaTiketDisplay.value = '';
                    totalBayarDisplay.value = '';
                    totalBayar.value = '';
                    tanggalReservasi.value = tanggalHariIni();
                }
            } catch (error) {
                console.error(error);
                hasil.innerHTML = `<div class="alert alert-danger">Gagal menghubungi server</div>`;
            }
        });
    </script>
</body>

</html>