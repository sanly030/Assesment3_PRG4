<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tiket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
    <div class="container mt-4 mb-5">
        <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #2b92d6">
            <div class="container">
                <a class="navbar-brand fw-bold" href="#">PRG4 Assessments</a>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <!-- Tiket -->
                        <li class="nav-item ms-3">
                            <a class="nav-link" href="ReadTiket.html" id="nav-tiket-read">Tiket</a>
                        </li>
                        <!-- Transaksi Reservasi -->
                        <li class="nav-item ms-3">
                            <a class="nav-link" href="ReadReservasi.html" id="nav-reservasi-read">Reservasi</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <button type="button" class="btn btn-success mt-3" onclick="window.location.href='CreateTiket.html'">Create
            Tiket</button>
        <br />
        <br />

        <table class="table table-bordered table-striped">
            <thead class="table-secondary">
                <tr>
                    <th>ID Tiket</th>
                    <th>Nama</th>
                    <th>Harga</th>
                    <th>Kouta</th>
                    <th>Status</th>
                    <th class="text-center">Aksi</th>
                </tr>
            </thead>
            <tbody id="tbodyTiket"></tbody>
        </table>
        <div id="info" class="mt-2"></div>
    </div>

    <script>
        function textPrioritas(code) {
            switch (String(code)) {
                case "1":
                    return { text: "Rendah", cls: "bg-info text-white" };
                case "2":
                    return { text: "Sedang", cls: "bg-warning text-white" };
                case "3":
                    return { text: "Tinggi", cls: "bg-danger text-white" };
                default:
                    return { text: "-" };
            }
        }

        function textStatus(code) {
            return String(code) === "1" ? '<span class="badge bg-success">Tersedia</span>' : '<span class="badge bg-secondary">Tidak Tersedia</span>';
        }

        async function loadTiket() {
            function formatRupiah(num) {
                return Number(num).toLocaleString("id-ID");
            }
            try {
                const res = await fetch("https://asm.roniprsty.com/tiket/read.php");
                const json = await res.json();

                if (json.status !== "success") {
                    document.getElementById("info").innerHTML = `<div class="alert alert-danger">${json.message}</div>`;
                    return;
                }

                const tbody = document.getElementById("tbodyTiket");
                tbody.innerHTML = "";

                json.data.forEach((t) => {
                    tbody.innerHTML += `
                    
                    <tr>
                    <td>${t.tik_id}</td>
                    <td>${t.tik_nama}</td>
                    <td>${t.tik_harga}</td>
                    <td>${t.tik_kuota}</td>
                    <td>${textStatus(t.tik_status)}</td>

                    <td class="text-center">

                        <!-- Tombol Update -->
                        <a href="UpdateTiket.html?id=${t.tik_id}" 
                        class="btn btn-sm btn-warning me-1">
                        Update
                        </a>
                        
                        <!-- Tombol Soft Delete -->
                        <button class="btn btn-sm btn-danger" onclick="softDelete('${t.tik_id}')">
                        Soft Delete
                        </button>

                    </td>
                    </tr>
                `;
                });
            } catch (e) {
                document.getElementById("info").innerHTML = `<div class="alert alert-danger">Gagal load data</div>`;
            }
        }

        async function softDelete(id) {
            if (!confirm("Yakin ingin menghapus (soft delete) Tiket " + id + " ?")) return;
            try {
                const res = await fetch("https://asm.roniprsty.com/tiket/delete.php", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ tik_id: id }),
                });
                const json = await res.json();

                document.getElementById("info").innerHTML = `<div class="alert alert-${json.status === "success" ? "success" : "danger"}">${json.message}</div>`;

                if (json.status === "success") {
                    loadTiket();
                }
            } catch (e) {
                document.getElementById("info").innerHTML = `<div class="alert alert-danger">Gagal menghubungi server</div>`;
            }
        }

        loadTiket();
    </script>
    <script>
        const path = window.location.pathname.split("/").pop();
        if (path.includes("ReadTiket")) document.getElementById("nav-tiket-read").classList.add("active");
        else if (path.includes("reservasi-read")) document.getElementById("nav-reservasi-read").classList.add("active");
    </script>
</body>

</html>